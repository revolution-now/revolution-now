# ===============================================================
# spread-render.rds
#
# Project: Revolution Now
#
# Created by David P. Sicilia on 2025-01-20.
#
# Description: Rds definitions for the spread-render module.
#
# ===============================================================
# config
include "config/tile-enum-fwd.hpp"

# gfx
include "gfx/spread-algo.rds.hpp"
include "gfx/cartesian.hpp"
include "gfx/pixel.hpp"

# C++ standard library
include "<vector>"

namespace "rn"

# ---------------------------------------------------------------
# Spread labels.
# ---------------------------------------------------------------
sumtype.SpreadLabelPlacement {
  # This will put the label on the left side of the first tile in
  # the middle, but with the exact x coordinate tweaked depending
  # on the count and spacing of the icons in order to produce a
  # more polished look.
  left_middle_adjusted {},

  in_first_tile {
    placement 'gfx::e_cdirection',
  },

  in_total_rect {
    placement 'gfx::e_cdirection',
  },
}

# When an option is not specified then a default value will be
# used, and those default values are chosen so as to provide sen-
# sible output that should be good in most cases (and roughly re-
# produce what the OG does).
struct.SpreadLabelOptions {
  # Foreground color, defaults to white.
  color_fg 'base::maybe<gfx::pixel>',
  # Background color, defaults to black.
  color_bg 'base::maybe<gfx::pixel>',
  # Placement defaults to the sw corner (NOTE: OG does nw).
  placement 'base::maybe<SpreadLabelPlacement>',
  # The padding is in addition to the one pixel of padding there
  # will naturally be around any font. Default value is 1,
  # whereas the OG has zero.
  text_padding 'base::maybe<int>',
}

sumtype.SpreadLabels {
  never {}, # default; should be first.
  always {},
  # Use some heuristics on a per-spread basis to determine
  # whether there should be a number or not.
  auto_decide {
    # If one spread gets a label then they all will.
    viral 'bool',
  },
}

# ---------------------------------------------------------------
# Spreads of tiles.
# ---------------------------------------------------------------
struct.TileSpreadSpec {
  icon_spread 'Spread',
  tile 'e_tile',
  # This can be used for e.g. a red X over each tile as would be
  # done in the colony view to represent shortages.
  overlay_tile 'base::maybe<e_tile>',
  # If labels are rendered for this spread then they will use
  # these options.
  label_opts 'SpreadLabelOptions',
}

struct.TileSpreadSpecs {
  spreads 'std::vector<TileSpreadSpec>',
  # Should use the same one as was used in the input SpreadSpecs
  # for correct behavior.
  group_spacing 'int',
  label_policy 'SpreadLabels',
}

# ---------------------------------------------------------------
# Render Plans.
# ---------------------------------------------------------------
struct.SpreadLabelRenderPlan {
  # Copied from input as-is.
  options 'SpreadLabelOptions',
  text 'std::string',
  # nw corner of where to render the box.
  where 'gfx::point',
}

struct.TileRenderPlan {
  tile 'e_tile',
  where 'gfx::point',
}

struct.TileSpreadRenderPlan {
  # This will be relative to the origin of the entire group if
  # there are multiple spreads involved.
  bounds 'gfx::rect',
  # These must be rendered in order.
  tiles 'std::vector<TileRenderPlan>',
  label 'base::maybe<SpreadLabelRenderPlan>',
}

# Final result which is directly renderable.
struct.TileSpreadRenderPlans {
  plans 'std::vector<TileSpreadRenderPlan>',
}
