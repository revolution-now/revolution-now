Todo:

  * There is an additional losing condition which appears to
    happen when the King controls 90% of the population of the
    new world, even if there are rebel coastal colonies still un-
    captured (not 100% sure about this, need to confirm).

  * The OG has a field called ref_captured_colony. Need to figure
    out how/when this is set.

  * When an REF ship sails back it will be put back into the
    stock when it arrives. Then it can be used again. That said,
    even if there are no ships left, a new one seems to be pro-
    duced every two turns, provided the REF hasn't forfeighted.

  * When the REF own a colony the flag is not white but the color
    of the pre-declaration colonial nation.

  * The SG indicates that, after declaration, the production
    within a colony gets penalized the higher the tory sentiment.
    Don't think this has been observed, but should be checked.

  Tory Uprisings:

    * Starts happening once the REF units in stock are destroyed,
      and where there is at least one colony eligible for upris-
      ing. If the REF would have otherwise forfeighted at this
      point then this will delay forfeight. Essentially, it pro-
      vides a mechanism for continued pressure on the player even
      after the REF has been eliminated. That said, each colony
      can only have one uprising, and must have few defenses, so
      the likelihood that the player will see this is low.
    * Conditions for happening:
        - REF stock units depleted, or sufficiently depleted that
          no more will be sent.
        - Colony has `tory_uprising=false`.
        - Colony is in the hands of the rebels.
        - Colony has sufficiently low defenses.
        - Dice roll to determine whether the uprising happens,
          probability seems related to SoL, but not sure.
        - Colony does /not/ need to be a port colony.
    * Happens to at most one colony per turn.
    * It appears to iterate through the colonies in order,
      rolling dice for each based on SoL and/or defense strength.
      As soon as there is one uprising it stops and doesn't do
      any further colonies. If it gets through the colonies with
      no uprising then none will happen that turn.
    * Can delay surrender. Specifically, even when the REF could
      otherwise surrender (holds no colonies, no REF units in
      stock) the surrender can be delayed if there is an uprising
      that turn.
    * The uprising REF units attack on the same turn (check
      this).
    * SoL: Can happen at any SoL.
    * Requires sufficiently low defenses.
        - Prefers weaker colonies.
        - Searches colonies in order of founding and seems to
          prefer earlier ones, all else being equal.
        - Will not choose colonies that have sufficient defenses.
    * Does not require muskets/horses in colony.
    * Probability that it happens to a colony:
        * Zero if defenses lead to too few units.
        * Depends on difficulty level.
        * Not clear if it depends on SoL.
        * Since the exact formula is not known, we will use this:

            P_colony = D + T/4

          where D is:

            discoverer:   25%
            explorer:     38%
            conquistador: 50%
            governor:     63%
            viceroy:      75%

          and T is the tory percent in the colony / 4. So on
          Viceroy, if the tory percent is 100% then we have
          75%+100%/4 = 100%. On discoverer, if the Tory percent
          is 0% then we have 25%+0% = 25%. This is likely not the
          same formula that the OG uses, but it seems to roughly
          fit what was observed and should be good enough.

    * Randomness:
        * Some randomness in whether it happens on a given turn.
        * No randomness in the colony chosen.
    * Units chosen:
        - The unit count is given by:
            T*2 + 3 - S + D
          where T is the number of tories in the colony, S is
          the total strength of the units in the colony (ar-
          tillery=7, soldier=2, etc), and D is the difficulty
          term:
            discoverer:   -2
            explorer:     -1
            conquistador:  0
            governor:     +1
            viceroy:      +2
          There is no floor on it; if the above formula yields 1,
          then only one unit will be deployed.
        - Units are chosen randomly from this distribution:
            soldier         : 45%
            veteran_soldier : 30%
            dragoon         : 15%
            veteran_dragoon : 10%
          Occasionally there are also free colonists chosen it
          appears, but those are rare and appear to have no pur-
          pose since they can't attack, so we won't choose them.
    * The OG has a flag in the colony called `tory_uprising` that
      marks when it happens to a colony.
        - Gets set when the uprising happens, not when the colony
          is captured.
        - It means that it can only happen at most once to a
          given colony.
        - If a colony with tory_uprising=true is recaptured by
          the rebels, that flag does not get reset to false. So
          once it happens to a colony, it cannot happen again.
        - We need one of these.
    * Units consist of:
        - soldiers
        - dragoons
        - v. soldiers
        - v. dragoons

Done:

  * Can we abandon a colony after declaration?

      - Yes, according to the usual rules. However, note that
        when the REF lands then the usual siege rules apply as
        well, which state that if the number of enemy units out-
        number the number of friendly military units in the
        colony then the colonists cannot be moved out of the
        colony, which prevents abandonment.

  * The algo used to select which REF unit gets added appears to
    have the following properties:

      * Not random.
      * Tends toward fixed distribution:

        Unit       N    PC/total  PC/land
        -------------------------------------------------
        regulars:  638  (57.42%)  (63.16%)
        cavalry:   213  (19.17%)  (21.08%)
        artillery: 159  (14.31%)  (15.74%)
        ships:     101  ( 9.09%)  (------)

      * Each turn the unit type that gets increased is the one
        that makes the distribution farthest away from the target
        distribution.

      * In order to have just the right number of ships to trans-
        port all of the ground units without reusing any ships we
        would need to have the ships percentage at 1/7 (~14%).
        However, in practice it is always less than this. Maybe a
        reason for this is that it allows a strategy where at-
        tacking ships can end the war early by causing the REF to
        run out of transport ships. But either way, we will keep
        this.

  * The King's expeditionary force expands whenever the nation's
    royal_money field hits a threshold.  It is increased by the
    following mechanism:

      Constant term per turn:
        Discoverer:   10
        Explorer:     18
        Conquistador: 26
        Governor:     34
        Viceroy:      42

      Any tax revenue received also adds to this:

        - Any sale of commodities in the harbor or through the
          custom house.
        - Un-equipping a dock unit with muskets/tools/horses and
          selling them, which in the OG (probably a bug) does not
          get taxed, but in the NG it does to prevent cheating.
        - Treasure delivered by king.
        - Treasure brought to europe.

      Threshold: 1800.  When it gets to this value it wraps around
      and one unit is added.

  * When independence is declared, the player's turn immediately
    ends. It appears that the ref moves last after all nations.
    Moreover, during the same turn as independence is declared,
    the king's army appears to use its turn to land, but does not
    attack. Then, at the start of the next turn, some messages
    are shown, then armies are promoted, then a normal turn pro-
    ceeds where the player gets to move, then the ref.

  * To choose which tile to land the ship on, the OG appears to
    select the tile with the most number of land tiles sur-
    rounding it, though this mechanism is buggy because it
    doesn't take into account how many of those land tiles are
    actually adjacent to the colony, so can end up placing the
    ship in a location where no units can land. But it seems that
    the intention was to maximize number of landing sites, so we
    will try to mirror that.

  * Once the ship landing tile is chosen then it chooses where to
    deploy the troops. It looks at all the available tiles and
    picks the one with the fewest units on it (it goes by number
    and not strength). If all tiles have the same number of units
    on it then it will just deploy as if they are all empty and
    capture whatever is necessary. If there are tiles available
    without units on them then it will unload everything there.

  * When the King's ships land on a colony they first choose the
    water tile that they will land on, without regard to which
    ships are there. If there is a ship there it will be cap-
    tured. Then they look at the available land squares. Then
    units will land on all accessible land tiles without foreign
    units on them. If there are none then the units there will be
    captured.

  * The initial colony seems to be chosen deterministically.

  * It appears to re-evaluate the strength of the colonies on
    each turn to find the target one (weakest?). Since if you let
    it choose an initial colony and send units there, it will
    continue sending units there if you don't add more units into
    it. But if you then add a strong defense into that colony
    then it will choose a difference (weaker) colony on the next
    turn.

  * The presence of a stockade/fort/fortress does not seem to af-
    fect the choice of colony.

  * It appears that the REF changes the units it sends depending
    on whether the squares that it would unload on have a
    visitor_nation equal to the REF nation or not. It may do this
    in order to know whether it landed there already. Because if
    it has landed there already and the colony still hasn't been
    taken, then it probably just sends reinforcements.

       * visitor_nation is empty  --> 1/1/1  (visited)
       * visitor_nation is player --> 2/1/0  (not visited)
       * visitor_nation is REF    --> 1/1/1  (visited)

  * The first wave of units can have these distributions:

      6: 2/2/2
      6: 4/1/1
      5: 3/1/1
      4: 2/1/1
      --------------
      3: 2/1/0

    The second wave has been observed to have:

      6: 2/2/2
      6: 4/1/1
      5: 3/1/1
      4: 2/1/1
      --------------
      3: 1/1/1

    The game seems to prefer weak colonies to attack. So the
    2/1/0 in the first wave could be so that if it is a super
    weak colony and it is the first time we are landing, then it
    is likely we will take the colony, so we don't want to waste
    artillery, especially if it is e.g. a remote mining colony.
    It will still get a second wave which will be 1/1/1 and thus
    will use an artillery, but this way way we only waste 1 in-
    stead of two.

  * When a colony gets REF units for the first time, unless the
    player quickly stocks the colony with defenses before those
    units attack, it seems that that same colony will always get
    a second round (before the first attack) even if it is a
    super weak colony.

  * The REF tries to avoid landing on squares that don't have
    visitor_nation=REF if possible.

  * The colony that it chooses on a given turn does not seem to
    be influenced by the vistor_nation status of the surrounding
    tiles of the colonies. It seems to just pick a colony using
    some deterministic algorithm, then look at the land sur-
    rounding it for visitor_nation together with the colony de-
    fenses, then it decides the units to bring.

  * The colony is chosen by first checking if there are any
    colonies that are completely undefended (no non-scout mili-
    tary units at the gate) and, if there are, choosing the
    colony among them that was founded first. If there are none,
    then it will choose among all colonies and pick the one that
    was founded first. In the NG, "founded first" translates to
    "the smallest colony ID".

  * REF Forfeight algo:

      Forfeight happens at the end of the REF's turn.

      If there are REF land units on the map, no matter what type
      or what continent, or if there are any REF owned colonies
      (even inland) the war goes on, and new ships get created if
      needed.

      Else if regulars in stock <= 1 and ships in stock == 0
      then forfeight.

    It doesn't seem to mean anything on its own when the REF runs
    out of ships, it just creates more, at a rate of one every
    two turns, provided the REF hasn't forfeighted.

    If the war starts with zero regulars (even if there are many
    of all other units). In this case, the initial ship brings no
    units and the REF just forfeights. This could be a bug of
    some kind, so we won't be replicating that here, since our
    rules dictate that if there are ships remaining and some land
    units remaining (of any type) then there is no forfeight.

  * REF ship resupply:

    * When the REF has no ships in stock or in the new world then
      it will produce a new one every second turn. The way it
      does this is that on a turn that it would have deployed, if
      there are no ships either in stock or in the new world,
      then it will create one in stock, but not deploy. Then on
      the next turn it will see that ship and deploy it.

    * This only happens when there would be more units to deploy.